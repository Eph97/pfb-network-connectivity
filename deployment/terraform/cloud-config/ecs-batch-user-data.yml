#cloud-config

packages:
    - awslogs

runcmd:
  - curl -o /etc/papertrail-bundle.pem https://papertrailapp.com/tools/papertrail-bundle.pem
  # Manually mount i3 family ephemeral storage, see:
  # https://bugs.launchpad.net/cloud-init/+bug/1672833
  # Before mounting, we need to stop the docker daemon and ECS agent. If we don't, then those
  # services don't see the changed file handles at the mount point and continue to write data
  # to the root volume at the block device mount point
  # NOTE: It may be possible for a job to get taken before we have a chance to stop these
  #       services. Not sure what the behavior is in that case. If we start seeing that once
  #       autoscaling is implemented we'll need to address it separately
  - stop ecs
  - service docker stop
  - mkfs.ext4 -E nodiscard /dev/nvme0n1
  - mkdir -p /media/nvme0n1
  - echo -e "/dev/nvme0n1\t/media/nvme0n1\text4\tdefaults,nofail,discard\t0\t2" >> /etc/fstab
  - mount -a
  - service docker start
  - start ecs

write_files:
  - path: /etc/ecs/ecs.config
    permissions: 0644
    owner: root:root
    content: |
      ECS_CLUSTER=${ecs_cluster_name}
  - path: /etc/awslogs/awslogs.conf
    permissions: 0644
    owner: root:root
    content: |
      [general]
      state_file = /var/lib/awslogs/agent-state

      [/var/log/dmesg]
      file = /var/log/dmesg
      log_group_name = log${environment}BatchContainerInstance
      log_stream_name = dmesg/{instance_id}

      [/var/log/messages]
      file = /var/log/messages
      log_group_name = log${environment}BatchContainerInstance
      log_stream_name = messages/{instance_id}
      datetime_format = %b %d %H:%M:%S

      [/var/log/docker]
      file = /var/log/docker
      log_group_name = log${environment}BatchContainerInstance
      log_stream_name = docker/{instance_id}
      datetime_format = %Y-%m-%dT%H:%M:%S.%f

      [/var/log/ecs/ecs-init.log]
      file = /var/log/ecs/ecs-init.log.*
      log_group_name = log${environment}BatchContainerInstance
      log_stream_name = ecs-init/{instance_id}
      datetime_format = %Y-%m-%dT%H:%M:%SZ

      [/var/log/ecs/ecs-agent.log]
      file = /var/log/ecs/ecs-agent.log.*
      log_group_name = log${environment}BatchContainerInstance
      log_stream_name = ecs-agent/{instance_id}
      datetime_format = %Y-%m-%dT%H:%M:%SZ

  - path: /etc/init/awslogs.conf
    permissions: 0644
    owner: root:root
    content: |
      description "Configure and start CloudWatch Logs agent on Amazon ECS container instance"
      author "Amazon Web Services"
      start on started ecs
      script
          exec 2>>/var/log/ecs/cloudwatch-logs-start.log
          set -x
          until curl -s http://localhost:51678/v1/metadata
          do
              sleep 1
          done
          service awslogs start
          chkconfig awslogs on
      end script
