#!/bin/bash
set -e

if [[ -n "${PFB_DEBUG}" ]]; then
    set -x
fi

if [[ -n "${GIT_COMMIT}" ]]; then
    GIT_COMMIT="${GIT_COMMIT:0:7}"
else
    GIT_COMMIT="$(git rev-parse --short HEAD)"
fi

DIR="$(dirname "$0")"

function usage() {
    echo -n \
         "Usage: $(basename "$0")
Build application for staging or a release.
"
}

if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    if [ "${1:-}" = "--help" ]; then
        usage
    else
        # Note: tests are run and the files are copied using the :latest images, which should be
        # fine because CI first runs scripts/update, which builds all containers.

        echo "Running tests"
        "${DIR}/test"
        echo "All tests pass!"

        # Copy static angular site to nginx srv directory
        echo "Copying angular site to nginx"
        pushd "${DIR}/../src/nginx"
        docker run -i -v "${PWD}/srv/dist:/static-export/dist" pfb-angularjs \
               rsync -rlptDv --delete --exclude .gitkeep \
                 /opt/pfb/angularjs/dist /static-export/
        popd

        echo "Building container images"
        GIT_COMMIT="${GIT_COMMIT}" docker-compose \
                  -f "${DIR}/../docker-compose.yml" \
                  -f "${DIR}/../docker-compose.test.yml" \
                  build

        echo "Building pfb-analysis container image"
        pushd pfb-analysis
        GIT_COMMIT="${GIT_COMMIT}" docker build -t "pfb-analysis:${GIT_COMMIT}" .
        popd
    fi
fi
